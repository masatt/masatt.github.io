<!DOCTYPE html>
<html>
<head>
<title>Medication Tracker</title>
<style>
  /* Basic styles for calendar and medication list */
  .calendar {
    border-collapse: collapse;
    width: 100%;
  }
  .calendar th, .calendar td {
    border: 1px solid black;
    padding: 8px;
    text-align: center;
  }
  .medication-list {
    margin-top: 20px;
  }
</style>
</head>
<body>
<h2>Medication Tracker</h2>
<!-- 薬の情報を入力するためのフォーム -->
<form id="medicationForm">
  <!-- 1つ目の薬 -->
  <input type="text" id="medicationName1" placeholder="Medication Name 1">
  <input type="number" id="medicationPills1" placeholder="Remaining Pills 1">

  <!-- 2つ目の薬 -->
  <input type="text" id="medicationName2" placeholder="Medication Name 2">
  <input type="number" id="medicationPills2" placeholder="Remaining Pills 2">

  <!-- 3つ目の薬 -->
  <input type="text" id="medicationName3" placeholder="Medication Name 3">
  <input type="number" id="medicationPills3" placeholder="Remaining Pills 3">

  <button type="button" onclick="saveMedications()">Save Medications</button>
</form>
    
<!-- Start date input -->
<label for="startDate">Start Date:</label>
<input type="date" id="startDate">
<button onclick="handleStartDateChange()">Generate Calendar</button>

<!-- Medication list to display remaining pills -->
<div class="medication-list"></div>

<!-- Calendar layout -->
<table class="calendar">
  <!-- Calendar content will be dynamically generated by JavaScript -->
</table>

<script>
// 薬の初期残錠数を設定する変数
const initialPillCount = 60;
const durationDays = 59; // 60日間を計算するための値
    
// Example medication data (this should be replaced with real data)
let medications = [
  { name: 'Medication A', remainingPills: initialPillCount },
  { name: 'Medication B', remainingPills: initialPillCount },
  { name: 'Medication C', remainingPills: initialPillCount }
];
console.log('initial medications:', medications);

function saveMedications() {
  var newMedications = [];
  for (var i = 1; i <= 3; i++) {
    var name = document.getElementById('medicationName' + i).value;
    var pills = document.getElementById('medicationPills' + i).value;
    if (name && pills) {
      newMedications.push({ name: name, remainingPills: parseInt(pills, 10) });
    }
  }

  // 現在の開始日を取得（まだ設定されていない場合は設定しない）
  var currentStartDate = localStorage.getItem('medicationData') ? JSON.parse(localStorage.getItem('medicationData')).startDate : null;

  // medicationDataオブジェクトを更新
  const medicationData = {
    medications: newMedications,
    startDate: currentStartDate // 既存の開始日を維持
  };
  console.log('startDate in saveMedications :', startDate);
  console.log('medicationData in saveMedications :', medicationData);
  // 更新されたmedicationDataをlocalStorageに保存
  localStorage.setItem('medicationData', JSON.stringify(medicationData));

  // フォームをリセット
  document.getElementById('medicationForm').reset();
}

    
// Update remaining pills count
function updatePillCount(medicationName, increment) {
  const medication = medications.find(med => med.name === medicationName);
  if (medication) {
    medication.remainingPills += increment;
    saveMedicationData();
  }
}
    
// Load saved medication data from LocalStorage
function loadMedicationData() {
  const savedData = localStorage.getItem('medicationData');
  if (savedData) {
    const parsedData = JSON.parse(savedData);
    medications = parsedData.medications || [];
    medications.forEach(medication => {
      if (!medication.takenDates) {
        medication.takenDates = [];
      }
    });
    if (parsedData.startDate) {
      // startDateを読み込んで設定
      document.getElementById('startDate').value = parsedData.startDate;
      const startDate = new Date(parsedData.startDate);
      if (!isNaN(startDate)) {
        generate3MonthCalendar(startDate); // 有効なstartDateがある場合、カレンダーを生成
      }
    }
  } else {
    const today = new Date();
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    generate3MonthCalendar(today); // startDateがない場合、現在の日付でカレンダーを生成
  }
  generateMedicationList(); // Update the medication list display
}

    
// Save medication data to LocalStorage
function saveMedicationData() {
  const medicationData = {
    medications: medications,
    startDate: document.getElementById('startDate').value // startDateを含める
  };
  localStorage.setItem('medicationData', JSON.stringify(medicationData));
  generateMedicationList(); // Update the medication list display
}

// Display the remaining pills for each medication
function generateMedicationList() {
　console.log('Current medications:', medications); // これによりmedicationsの内容を確認できます。
  const listContainer = document.querySelector('.medication-list');
  listContainer.innerHTML = '';
  medications.forEach(med => {
    listContainer.innerHTML += '<p>' + med.name + ': Remaining pills - ' + med.remainingPills + '</p>';
  });
}

// Helper function to get the number of days in a given month
function daysInMonth(month, year) {
  return new Date(year, month, 0).getDate();
}

// Helper function to generate a calendar for a specific month and year
function generateMonthCalendar(month, year, startDate, endDate) {
  const firstDayOfMonth = new Date(year, month, 1).getDay();
  const daysInThisMonth = daysInMonth(month + 1, year);

  let calendarHtml = '<tr><th colspan="7">' + new Date(year, month).toLocaleString('default', { month: 'long' }) + ' ' + year + '</th></tr><tr>';
  // Create empty cells until the first day of the month
  for (let i = 0; i < firstDayOfMonth; i++) {
    calendarHtml += '<td></td>';
  }

  // Fill the rest of the cells with the days of the month and checkboxes for each medication
  // generateMonthCalendar function
  for (let day = 1; day <= daysInThisMonth; day++) {
    const currentDate = new Date(year, month, day);
    if ((day + firstDayOfMonth - 1) % 7 === 0) {
      calendarHtml += '</tr><tr>';
    }
    calendarHtml += '<td>';
    if (compareDates(currentDate, startDate) || (currentDate > startDate && currentDate <= endDate)) {
      medications.forEach(medication => {
        const checkBoxId = 'med-' + medication.name.replace(/\s+/g, '') + '-' + year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        calendarHtml += '<div><input type="checkbox" id="' + checkBoxId + '" onchange="handleCheckboxChange(this, \'' + medication.name + '\', ' + year + ', ' + (month + 1) + ', ' + day + ')" />' + medication.name + '</div>';
      });
    }
    calendarHtml += day + '</td>';
  }
  calendarHtml += '</tr>';
  return calendarHtml;
}

// Function to generate a 3-month calendar starting from a given date
function generate3MonthCalendar(startDate) {
  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + durationDays); // 60 days including the start date

  const startMonth = startDate.getMonth();
  const startYear = startDate.getFullYear();
  const endMonth = endDate.getMonth();
  const endYear = endDate.getFullYear();

  let calendarHtml = '';
  for (let year = startYear; year <= endYear; year++) {
    const monthStart = year === startYear ? startMonth : 0;
    const monthEnd = year === endYear ? endMonth : 11;
    for (let month = monthStart; month <= monthEnd; month++) {
      calendarHtml += generateMonthCalendar(month, year, startDate, endDate);
    }
  }

  document.querySelector('.calendar').innerHTML = calendarHtml;
  restoreCheckboxStates(); // Restore the states of checkboxes after generating the calendar
}

function restoreCheckboxStates() {
  console.log("medications with takenDates:", medications); // デバッグ用
  medications.forEach(medication => {
    medication.takenDates.forEach(date => {
      const checkboxId = 'med-' + medication.name.replace(/\s+/g, '') + '-' + date.replace(/-/g, '-');
      const checkbox = document.getElementById(checkboxId);
      console.log("Attempting to restore: " + checkboxId, checkbox); // デバッグ用
      if (checkbox) {
        checkbox.checked = true;
        console.log("Restoring Checkbox ID: " + checkboxId, checkbox);
      }
    });
  });
}


// Function to handle checkbox change event
function handleCheckboxChange(checkbox, medicationName, year, month, day) {
  // JavaScriptのDateオブジェクトに合わせて月の値を調整
  const adjustedMonth = month - 1; // 1月は0、2月は1とする
  const date = year + '-' + String(adjustedMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
  updateMedicationTakenDates(medicationName, date, checkbox.checked);
  updatePillCount(medicationName, checkbox.checked ? -1 : 1);
}

// Update medication taken dates based on checkbox changes
function updateMedicationTakenDates(medicationName, date, taken) {
  const medication = medications.find(med => med.name === medicationName);
  if (medication) {
    if (!medication.takenDates) {
      medication.takenDates = []; // Initialize takenDates if it's not defined
    }

    if (taken) {
      if (!medication.takenDates.includes(date)) {
        medication.takenDates.push(date); // Add new date
      }
    } else {
      medication.takenDates = medication.takenDates.filter(d => d !== date); // Remove date
    }
    console.log("Before saving:", medications);
    saveMedicationData();
    console.log("After saving:", medications);
  }
}

// Helper function to compare dates (ignoring time)
function compareDates(date1, date2) {
  return date1.getFullYear() === date2.getFullYear() &&
         date1.getMonth() === date2.getMonth() &&
         date1.getDate() === date2.getDate();
}

// Function to reset medication states
function resetMedicationStates() {
  medications.forEach(medication => {
    medication.remainingPills = initialPillCount; // Reset to the initial pill count
    medication.takenDates = []; // Clear the taken dates
  });
}

// Event handler for the start date input and calendar generation
function handleStartDateChange() {
  const startDateInput = document.getElementById('startDate');
  const startDate = new Date(startDateInput.value);
  console.log('in handleStartDateChange, startDate:', startDate);
  if (!isNaN(startDate)) {
    generate3MonthCalendar(startDate);
    saveMedicationData(); // Save the updated state with the new start date
  } else {
    alert('Invalid date format. Please enter a valid date.');
  }
  generateMedicationList(); // Update the medication list display
}


// Initialize the application
window.onload = function() {
  loadMedicationData();
};

</script>
</body>
</html>
